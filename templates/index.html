<!DOCTYPE html>
<html>

<head>
    <title>Pattern Matcher</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(to right, #1c1c1c, #2d2d2d);
            color: #eee;
            padding: 30px;
            margin: 0;
        }

        h1 {
            color: #fbb034;
            text-align: center;
        }

        .layout {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 30px;
            min-height: 70vh;
        }

        .column {
            max-width: 300px;
            font-size: 15px;
            color: #ccc;
            flex: 1 1 300px;
        }

        .form-box {
            background-color: #333;
            padding: 25px;
            border-radius: 12px;
            max-width: 400px;
            width: 100%;
            flex: 0 1 400px;
        }

        input,
        select,
        button {
            margin: 10px 0;
            padding: 10px;
            font-size: 16px;
            width: 100%;
            border-radius: 5px;
            border: none;
        }

        button {
            background-color: #fbb034;
            color: black;
            font-weight: bold;
            cursor: pointer;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: #ccc;
            text-align: left;
        }

        img {
            margin: 20px auto;
            display: block;
            max-width: 95%;
            border-radius: 10px;
        }

        .summary {
            background-color: #212121;
            border-left: 6px solid #fbb034;
            text-align: left;
            padding: 20px;
            margin-top: 20px;
            white-space: pre-wrap;
            color: #c5e1a5;
            font-size: 15px;
            border-radius: 10px;
        }

        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000a;
            color: #fff;
            font-size: 22px;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none;
        }

        .donation-box {
            background-color: #444;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            flex: 0 1 320px;
        }

        .donation-box h4 {
            color: #fbb034;
        }

        .crypto-address {
            font-size: 13px;
            color: #ddd;
            margin: 8px 0;
            word-break: break-word;
        }

        .copy-btn {
            background-color: #666;
            color: #fff;
            border: none;
            padding: 3px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .copy-btn:hover {
            background-color: #888;
        }
    </style>
</head>

<body>
    <h1>Candlestick Pattern Matcher</h1>

    <div id="loading">üîç Searching for similar patterns... Please wait...</div>

    <div class="layout">
        <!-- Left: Instructions + Why -->
        <div class="column">
            <h3>How to Use</h3>
            <p>Take a snapshot of any candlestick chart</p>
            <p>Upload or paste the image below</p>
            <p>We match it to similar historical patterns</p>
            <p>See what happened next</p>

            <h3 style="margin-top: 30px;">Why This Tool?</h3>
            <p>Pattern recognition helps traders evaluate probability.</p>
            <p><strong>History Repeats Itself</strong></p>
            <p>Learn from similar past behavior to make smarter decisions.</p>
        </div>

        <!-- Center: Form -->
        <form class="form-box" method="POST" enctype="multipart/form-data">
            <label>Upload or Paste Chart Image:</label>
            <input type="file" name="pattern" accept="image/*" required>

            <label>Matching Threshold (%):</label>
            <input type="number" name="threshold" min="50" max="100" step="1" value="90">

            <label>Number of Top Matches to Show:</label>
            <input type="number" name="top_n" min="1" max="20" step="1" value="5">

            <label>Select Asset:</label>
            <select name="asset" id="assetSelect" required onchange="updateTimeframes()">
                <option value="" disabled selected>Select asset</option>
                {% for asset in assets_timeframes.keys() %}
                <option value="{{ asset }}">{{ asset }}</option>
                {% endfor %}
            </select>

            <label>Select Timeframe:</label>
            <select name="timeframe" id="timeframeSelect" required>
                <option value="" disabled selected>Select timeframe (lower timeframe longer processing)</option>
            </select>

            <script>
                const assetsTimeframes = {{ assets_timeframes| tojson }};
                const assetSelect = document.getElementById('assetSelect');
                const timeframeSelect = document.getElementById('timeframeSelect');

                function updateTimeframes() {
                    const selectedAsset = assetSelect.value;
                    const timeframes = assetsTimeframes[selectedAsset] || [];

                    timeframeSelect.innerHTML = '<option value="" disabled selected>Select timeframe</option>';
                    timeframes.forEach(tf => {
                        const option = document.createElement('option');
                        option.value = tf;
                        option.textContent = tf;
                        timeframeSelect.appendChild(option);
                    });
                }
            </script>


            <button type="submit">üîç Find Matches</button>
        </form>

        <!-- Right: Donation -->
        <div class="donation-box">
            <h4>üíñ Support the Developer</h4>
            <p style="font-size: 14px;">If you found this tool useful, consider a small donation:</p>
            <a href="https://www.paypal.me/DaoudMaDaoud" target="_blank" style="display:inline-block; background-color:#0070ba; color:white; padding:8px 16px; 
                border-radius:6px; text-decoration:none; font-weight:bold; margin-top:10px;">
                Donate via PayPal
            </a>
            <div style="margin-top: 15px; text-align:left;">
                <p class="crypto-address">USDT (Network:BEP20):<br>0xc7af03286f3b615e2f3cba5d82b495a3252e562c
                    <button class="copy-btn" onclick="copyText(this)">Copy</button>
                </p>
                <p class="crypto-address">USDT (Network:TRC20):<br>TBM1mr8WS9boLQ3FxNhUfcRRZuNw5rxtKa
                    <button class="copy-btn" onclick="copyText(this)">Copy</button>
                </p>
                <p class="crypto-address">USDC (Network:BEP20):<br>0xc7af03286f3b615e2f3cba5d82b495a3252e562c
                    <button class="copy-btn" onclick="copyText(this)">Copy</button>
                </p>
                <p class="crypto-address">USDC (Network:Solana):<br>DkZfpoSp9gRH4yARiFr73J9GZMkRoyq1H74retzyRfuA
                    <button class="copy-btn" onclick="copyText(this)">Copy</button>
                </p>
            </div>
        </div>
    </div>

    {% if matches %}
    <h2 id="results" style="text-align:center;">üìä Top Matches</h2>
    <button onclick="printMatches()" style="display:block; margin:10px auto;">üñ® Save Results as PDF</button>

    <div id="print-section">
        {% for img in matches %}
        <img src="{{ img }}">
        {% endfor %}
        <div class="summary">{{ summary|safe }}</div>
    </div>
    {% endif %}

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");
            form.addEventListener("submit", function () {
                document.getElementById("loading").style.display = "flex";
            });

            document.addEventListener('paste', function (event) {
                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.type.indexOf("image") === 0) {
                        const blob = item.getAsFile();
                        const fileInput = document.querySelector('input[type=file]');
                        const dataTransfer = new DataTransfer();
                        dataTransfer.items.add(blob);
                        fileInput.files = dataTransfer.files;
                    }
                }
            });

            if (window.location.href.includes("#results") === false && document.getElementById("results")) {
                window.location.hash = "results";
            }
        });

        function printMatches() {
            const printSection = document.getElementById("print-section");
            const win = window.open("", "", "width=1000,height=700");
            let html = `<html><head><title>Pattern Match Results</title><style>
                body { font-family: Arial, sans-serif; background: linear-gradient(to right, #1c1c1c, #2d2d2d); color: #eee; padding: 30px; margin: 0; }
                h2 { color: #fbb034; text-align: center; }
                img { margin: 20px auto; display: block; max-width: 95%; border-radius: 10px; }
                .summary { background-color: #212121; border-left: 6px solid #fbb034; text-align: left; padding: 20px; margin-top: 20px; white-space: pre-wrap; color: #c5e1a5; font-size: 15px; border-radius: 10px; }
            </style></head><body><h2>Candlestick Match Results</h2>`;
            html += printSection.innerHTML;
            html += '</body></html>';
            win.document.write(html);
            win.document.close();
            win.focus();
            win.print();
        }

        function copyText(button) {
            const text = button.parentElement.innerText.replace("Copy", "").trim();
            navigator.clipboard.writeText(text).then(() => {
                button.innerText = "‚úì Copied!";
                setTimeout(() => {
                    button.innerText = "Copy";
                }, 1500);
            });
        }
    </script>
</body>

</html>
